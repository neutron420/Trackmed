generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model addresses {
  id             String   @id
  user_id        String
  label          String?
  full_name      String
  phone          String
  address_line_1 String
  address_line_2 String?
  city           String
  state          String
  pincode        String
  country        String   @default("India")
  landmark       String?
  is_default     Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime
  users          users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  orders         orders[]

  @@index([is_default])
  @@index([user_id])
}

model analytics {
  id           String   @id
  date         DateTime @db.Date
  metric_type  String
  metric_value Decimal  @db.Decimal(15, 2)
  metadata     Json?
  created_at   DateTime @default(now())

  @@unique([date, metric_type])
  @@index([date])
}

model audit_trails {
  id                String   @id
  entity_type       String
  entity_id         String
  action            String
  field_name        String?
  old_value         String?
  new_value         String?
  performed_by      String
  performed_by_role String?
  metadata          Json?
  created_at        DateTime @default(now())

  @@index([created_at])
  @@index([entity_type, entity_id])
  @@index([performed_by])
}

model batches {
  id                 String          @id
  batch_hash         String          @unique
  manufacturing_date DateTime
  expiry_date        DateTime
  status             BatchStatus     @default(VALID)
  created_at         DateTime        @default(now())
  blockchain_tx_hash String?         @unique
  blockchain_pda     String?         @unique
  batch_number       String          @unique
  manufacturer_id    String
  medicine_id        String
  quantity           Int
  invoice_number     String?
  invoice_date       DateTime?
  gst_number         String?
  warehouse_location String?
  warehouse_address  String?
  lifecycle_status   LifecycleStatus @default(IN_PRODUCTION)
  updated_at         DateTime
  distributor_id     String?
  pharmacy_id        String?
  remaining_quantity Int             @default(0)
  image_url          String?
  distributors       distributors?   @relation(fields: [distributor_id], references: [id])
  manufacturers      manufacturers   @relation(fields: [manufacturer_id], references: [id])
  medicines          medicines       @relation(fields: [medicine_id], references: [id])
  pharmacies         pharmacies?     @relation(fields: [pharmacy_id], references: [id])
  cart_items         cart_items[]
  notifications      notifications[]
  order_items        order_items[]
  qr_codes           qr_codes[]
  scan_logs          scan_logs[]
  shipments          shipments[]

  @@index([batch_hash])
  @@index([batch_number])
  @@index([blockchain_tx_hash])
  @@index([created_at])
  @@index([distributor_id])
  @@index([expiry_date])
  @@index([lifecycle_status])
  @@index([manufacturer_id])
  @@index([medicine_id])
  @@index([pharmacy_id])
  @@index([status])
}

model cart_items {
  id         String   @id
  cart_id    String
  batch_id   String
  quantity   Int      @default(1)
  created_at DateTime @default(now())
  updated_at DateTime
  batches    batches  @relation(fields: [batch_id], references: [id])
  carts      carts    @relation(fields: [cart_id], references: [id], onDelete: Cascade)

  @@unique([cart_id, batch_id])
  @@index([batch_id])
  @@index([cart_id])
}

model carts {
  id         String       @id
  user_id    String       @unique
  created_at DateTime     @default(now())
  updated_at DateTime
  cart_items cart_items[]
  users      users        @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model chat_messages {
  id                                      String   @id
  sender_id                               String
  recipient_id                            String?
  message                                 String
  created_at                              DateTime @default(now())
  users_chat_messages_recipient_idTousers users?   @relation("chat_messages_recipient_idTousers", fields: [recipient_id], references: [id])
  users_chat_messages_sender_idTousers    users    @relation("chat_messages_sender_idTousers", fields: [sender_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([recipient_id])
  @@index([sender_id])
  @@index([sender_id, recipient_id])
}

model distributors {
  id             String      @id
  name           String
  license_number String      @unique
  address        String
  city           String?
  state          String?
  country        String      @default("India")
  phone          String?
  email          String?
  gst_number     String?
  is_verified    Boolean     @default(false)
  created_at     DateTime    @default(now())
  updated_at     DateTime
  is_active      Boolean     @default(true)
  batches        batches[]
  shipments      shipments[]

  @@index([created_at])
  @@index([is_active])
  @@index([is_verified])
  @@index([name])
}

model fraud_alerts {
  id          String         @id
  batch_id    String?
  qr_code_id  String?
  user_id     String?
  alert_type  FraudAlertType
  severity    FraudSeverity  @default(MEDIUM)
  description String
  evidence    Json?
  is_resolved Boolean        @default(false)
  resolved_at DateTime?
  resolved_by String?
  created_at  DateTime       @default(now())
  updated_at  DateTime
  users       users?         @relation(fields: [user_id], references: [id])

  @@index([batch_id])
  @@index([created_at])
  @@index([is_resolved])
  @@index([qr_code_id])
}

model manufacturers {
  id             String    @id
  name           String
  license_number String    @unique
  address        String
  city           String?
  state          String?
  country        String    @default("India")
  phone          String?
  email          String?
  gst_number     String?
  wallet_address String    @unique
  is_verified    Boolean   @default(false)
  created_at     DateTime  @default(now())
  updated_at     DateTime
  is_active      Boolean   @default(true)
  batches        batches[]

  @@index([created_at])
  @@index([is_active])
  @@index([is_verified])
  @@index([name])
  @@index([wallet_address])
}

model medicines {
  id                String    @id
  name              String
  generic_name      String?
  strength          String
  composition       String
  dosage_form       String
  mrp               Decimal   @db.Decimal(10, 2)
  storage_condition String?
  image_url         String?
  description       String?
  created_at        DateTime  @default(now())
  updated_at        DateTime
  batches           batches[]

  @@index([created_at])
  @@index([generic_name])
  @@index([name])
}

model notifications {
  id              String               @id
  type            NotificationType
  batch_id        String?
  message         String
  severity        NotificationSeverity
  is_read         Boolean              @default(false)
  read_at         DateTime?
  metadata        Json?
  target_roles    UserRole[]
  target_user_ids String[]
  created_at      DateTime             @default(now())
  updated_at      DateTime
  batches         batches?             @relation(fields: [batch_id], references: [id])

  @@index([batch_id])
  @@index([created_at])
  @@index([is_read])
  @@index([type])
}

model order_items {
  id                String   @id
  order_id          String
  batch_id          String
  medicine_name     String
  medicine_strength String
  quantity          Int
  unit_price        Decimal  @db.Decimal(10, 2)
  total_price       Decimal  @db.Decimal(10, 2)
  created_at        DateTime @default(now())
  batches           batches  @relation(fields: [batch_id], references: [id])
  orders            orders   @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@index([batch_id])
  @@index([order_id])
}

model orders {
  id                  String        @id
  order_number        String        @unique
  user_id             String
  address_id          String
  status              OrderStatus   @default(PENDING)
  payment_status      PaymentStatus @default(PENDING)
  payment_method      String?
  payment_id          String?
  subtotal            Decimal       @db.Decimal(10, 2)
  tax                 Decimal       @default(0) @db.Decimal(10, 2)
  delivery_fee        Decimal       @default(0) @db.Decimal(10, 2)
  discount            Decimal       @default(0) @db.Decimal(10, 2)
  total               Decimal       @db.Decimal(10, 2)
  notes               String?
  prescription_url    String?
  estimated_delivery  DateTime?
  delivered_at        DateTime?
  cancelled_at        DateTime?
  cancellation_reason String?
  created_at          DateTime      @default(now())
  updated_at          DateTime
  order_items         order_items[]
  addresses           addresses     @relation(fields: [address_id], references: [id])
  users               users         @relation(fields: [user_id], references: [id])

  @@index([created_at])
  @@index([order_number])
  @@index([payment_status])
  @@index([status])
  @@index([user_id])
}

model pharmacies {
  id             String    @id
  name           String
  license_number String    @unique
  address        String
  city           String?
  state          String?
  country        String    @default("India")
  phone          String?
  email          String?
  gst_number     String?
  is_verified    Boolean   @default(false)
  created_at     DateTime  @default(now())
  updated_at     DateTime
  image_url      String?
  is_active      Boolean   @default(true)
  batches        batches[]

  @@index([created_at])
  @@index([is_verified])
  @@index([name])
}

model playing_with_neon {
  id    Int    @id @default(autoincrement())
  name  String
  value Float? @db.Real
}

model push_tokens {
  id           String   @id
  user_id      String
  player_id    String   @unique
  device_type  String?
  device_model String?
  is_active    Boolean  @default(true)
  created_at   DateTime @default(now())
  updated_at   DateTime
  users        users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([player_id])
  @@index([user_id])
}

model qr_codes {
  id          String      @id
  code        String      @unique
  batch_id    String
  unit_number Int?
  is_active   Boolean     @default(true)
  created_at  DateTime    @default(now())
  updated_at  DateTime
  batches     batches     @relation(fields: [batch_id], references: [id])
  scan_logs   scan_logs[]

  @@index([batch_id])
  @@index([code])
}

model refresh_tokens {
  id          String   @id
  token       String   @unique
  user_id     String
  device_id   String?
  device_name String?
  expires_at  DateTime
  is_revoked  Boolean  @default(false)
  created_at  DateTime @default(now())
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([expires_at])
  @@index([is_revoked])
  @@index([token])
  @@index([user_id])
}

model reports {
  id            String       @id
  report_number String       @unique
  name          String
  type          ReportType
  status        ReportStatus @default(PENDING)
  parameters    Json?
  file_url      String?
  file_size     Int?
  format        String       @default("PDF")
  generated_by  String
  started_at    DateTime?
  completed_at  DateTime?
  error_message String?
  created_at    DateTime     @default(now())
  updated_at    DateTime

  @@index([created_at])
  @@index([generated_by])
  @@index([status])
  @@index([type])
}

model scan_logs {
  id                  String   @id
  qr_code_id          String
  batch_id            String
  user_id             String?
  device_id           String?
  device_model        String?
  device_os           String?
  app_version         String?
  location_lat        Decimal? @db.Decimal(10, 8)
  location_lng        Decimal? @db.Decimal(10, 8)
  location_address    String?
  scan_type           ScanType @default(VERIFICATION)
  blockchain_verified Boolean  @default(false)
  blockchain_status   String?
  created_at          DateTime @default(now())
  batches             batches  @relation(fields: [batch_id], references: [id])
  qr_codes            qr_codes @relation(fields: [qr_code_id], references: [id])
  users               users?   @relation(fields: [user_id], references: [id])

  @@index([batch_id])
  @@index([created_at])
  @@index([qr_code_id])
  @@index([user_id])
}

model shipment_tracking {
  id          String         @id
  shipment_id String
  status      ShipmentStatus
  location    String?
  description String?
  timestamp   DateTime       @default(now())
  created_at  DateTime       @default(now())
  shipments   shipments      @relation(fields: [shipment_id], references: [id], onDelete: Cascade)

  @@index([shipment_id])
  @@index([timestamp])
}

model shipments {
  id                 String              @id
  shipment_number    String              @unique
  batch_id           String
  distributor_id     String
  quantity           Int
  status             ShipmentStatus      @default(PENDING)
  pickup_address     String?
  delivery_address   String?
  tracking_number    String?
  carrier            String?
  estimated_delivery DateTime?
  shipped_at         DateTime?
  delivered_at       DateTime?
  notes              String?
  created_by         String
  created_at         DateTime            @default(now())
  updated_at         DateTime
  shipment_tracking  shipment_tracking[]
  batches            batches             @relation(fields: [batch_id], references: [id])
  distributors       distributors        @relation(fields: [distributor_id], references: [id])

  @@index([batch_id])
  @@index([created_at])
  @@index([distributor_id])
  @@index([status])
}

model users {
  id                                              String           @id
  email                                           String           @unique
  password_hash                                   String
  name                                            String?
  role                                            UserRole         @default(SCANNER)
  is_active                                       Boolean          @default(true)
  created_at                                      DateTime         @default(now())
  updated_at                                      DateTime
  avatar_url                                      String?
  is_email_verified                               Boolean          @default(false)
  is_phone_verified                               Boolean          @default(false)
  last_login_at                                   DateTime?
  phone                                           String?
  addresses                                       addresses[]
  carts                                           carts?
  chat_messages_chat_messages_recipient_idTousers chat_messages[]  @relation("chat_messages_recipient_idTousers")
  chat_messages_chat_messages_sender_idTousers    chat_messages[]  @relation("chat_messages_sender_idTousers")
  fraud_alerts                                    fraud_alerts[]
  orders                                          orders[]
  push_tokens                                     push_tokens[]
  refresh_tokens                                  refresh_tokens[]
  scan_logs                                       scan_logs[]

  @@index([created_at])
  @@index([email])
  @@index([is_active])
  @@index([role])
}

enum BatchStatus {
  VALID
  RECALLED
}

enum FraudAlertType {
  DUPLICATE_QR_CODE
  INVALID_BATCH_HASH
  EXPIRED_MEDICINE
  RECALLED_BATCH
  LOCATION_MISMATCH
  FREQUENT_SCANS
  UNAUTHORIZED_ACCESS
  BLOCKCHAIN_MISMATCH
}

enum FraudSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum LifecycleStatus {
  IN_PRODUCTION
  IN_TRANSIT
  AT_DISTRIBUTOR
  AT_PHARMACY
  SOLD
  EXPIRED
  RECALLED
}

enum NotificationSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum NotificationType {
  FRAUD_ALERT
  BATCH_RECALL
  BATCH_CREATED
  EXPIRY_WARNING
  LIFECYCLE_CHANGE
  LOW_STOCK
  STATUS_CHANGE
  SYSTEM
  BATCH_STATUS_CHANGED
  MANUFACTURER_OPERATION
  ADMIN_ACTION
  MANUFACTURER_VERIFIED
  MANUFACTURER_UPDATED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

enum ReportType {
  PRODUCTION
  INVENTORY
  SALES
  QUALITY
  VERIFICATION
  EXPIRY
  DISTRIBUTOR
  BATCH_SUMMARY
  FRAUD_ANALYSIS
}

enum ScanType {
  VERIFICATION
  PURCHASE
  DISTRIBUTION
  RECALL_CHECK
}

enum ShipmentStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  RETURNED
}

enum UserRole {
  ADMIN
  MANUFACTURER
  DISTRIBUTOR
  PHARMACY
  SCANNER
  CONSUMER
  SUPERADMIN
}
